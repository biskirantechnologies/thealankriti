<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Order Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .order-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <h1>üõí Quick Order Test - The Alankriti</h1>
    <p>Test placing orders from frontend and verify they appear in admin panel immediately.</p>

    <div class="section">
        <h2>1. User Authentication</h2>
        <button onclick="loginUser()">Login as Customer</button>
        <button onclick="registerUser()">Register New Customer</button>
        <div id="authResult"></div>
    </div>

    <div class="section">
        <h2>2. Quick Order Form</h2>
        <div class="order-form">
            <div>
                <label>Product Name:</label>
                <input type="text" id="productName" value="Test Jewelry Item" />
            </div>
            <div>
                <label>Price (NPR):</label>
                <input type="number" id="productPrice" value="2500" />
            </div>
            <div>
                <label>Customer Name:</label>
                <input type="text" id="customerName" value="Test Customer" />
            </div>
            <div>
                <label>Phone:</label>
                <input type="text" id="customerPhone" value="9876543210" />
            </div>
            <div>
                <label>Email:</label>
                <input type="email" id="customerEmail" value="test@example.com" />
            </div>
            <div>
                <label>Payment Method:</label>
                <select id="paymentMethod">
                    <option value="cod">Cash on Delivery</option>
                    <option value="qr-code">QR Code</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
        </div>
        <br>
        <button onclick="placeQuickOrder()" id="orderButton">Place Order</button>
        <div id="orderResult"></div>
    </div>

    <div class="section">
        <h2>3. Check Admin Panel</h2>
        <p>After placing an order above, use these buttons to check if it appears in the admin panel:</p>
        <button onclick="checkAdminOrders()">Check Admin Orders</button>
        <button onclick="openAdminPanel()">Open Admin Panel (New Tab)</button>
        <div id="adminResult"></div>
    </div>

    <script>
        let userToken = null;
        let adminToken = null;
        const API_BASE = 'http://localhost:3001/api';

        // Login existing user
        async function loginUser() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Logging in...</div>';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    userToken = data.token;
                    resultDiv.innerHTML = `<div class="success">‚úÖ Logged in as ${data.user.firstName} ${data.user.lastName}</div>`;
                    document.getElementById('customerName').value = `${data.user.firstName} ${data.user.lastName}`;
                    document.getElementById('customerEmail').value = data.user.email;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Register new user
        async function registerUser() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Registering new user...</div>';

            const randomId = Math.floor(Math.random() * 10000);
            const userData = {
                firstName: 'Test',
                lastName: `User${randomId}`,
                email: `test${randomId}@example.com`,
                password: 'password123',
                phone: `987654${randomId.toString().padStart(4, '0')}`
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    userToken = data.token;
                    resultDiv.innerHTML = `<div class="success">‚úÖ Registered as ${userData.firstName} ${userData.lastName}</div>`;
                    document.getElementById('customerName').value = `${userData.firstName} ${userData.lastName}`;
                    document.getElementById('customerEmail').value = userData.email;
                    document.getElementById('customerPhone').value = userData.phone;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Registration failed: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Place quick order
        async function placeQuickOrder() {
            if (!userToken) {
                document.getElementById('orderResult').innerHTML = '<div class="error">Please login first!</div>';
                return;
            }

            const resultDiv = document.getElementById('orderResult');
            const button = document.getElementById('orderButton');
            
            button.disabled = true;
            resultDiv.innerHTML = '<div class="info">Placing order...</div>';

            const orderData = {
                items: [{
                    product: "507f1f77bcf86cd799439011", // Dummy ObjectId
                    productSnapshot: {
                        name: document.getElementById('productName').value,
                        sku: `SKU-${Date.now()}`,
                        image: "/uploads/products/test.jpg",
                        price: parseInt(document.getElementById('productPrice').value),
                        specifications: {}
                    },
                    quantity: 1,
                    price: parseInt(document.getElementById('productPrice').value),
                    variant: {}
                }],
                customerInfo: {
                    firstName: document.getElementById('customerName').value.split(' ')[0] || 'Test',
                    lastName: document.getElementById('customerName').value.split(' ')[1] || 'Customer',
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value
                },
                shippingAddress: {
                    firstName: document.getElementById('customerName').value.split(' ')[0] || 'Test',
                    lastName: document.getElementById('customerName').value.split(' ')[1] || 'Customer',
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    street: "123 Test Street",
                    apartment: "",
                    city: "Kathmandu",
                    state: "Bagmati",
                    zipCode: "44600",
                    country: "Nepal"
                },
                payment: {
                    method: document.getElementById('paymentMethod').value,
                    status: "pending",
                    transactionId: `TXN-${Date.now()}`
                },
                pricing: {
                    subtotal: parseInt(document.getElementById('productPrice').value),
                    shippingCost: 100,
                    tax: Math.round(parseInt(document.getElementById('productPrice').value) * 0.05),
                    discount: 0,
                    total: parseInt(document.getElementById('productPrice').value) + 100 + Math.round(parseInt(document.getElementById('productPrice').value) * 0.05)
                },
                notes: {
                    customerNotes: "Quick order test",
                    specialInstructions: "Test order - please verify admin panel visibility",
                    giftMessage: ""
                },
                orderSource: "website-test",
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    timestamp: new Date().toISOString()
                }
            };

            try {
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Order placed successfully!<br>
                            Order ID: ${result.order.id}<br>
                            Order Number: ${result.order.orderNumber}<br>
                            Total: NPR ${orderData.pricing.total}<br>
                            <strong>Now check the admin panel to see if it appears!</strong>
                        </div>
                    `;
                    
                    // Auto-check admin orders after 2 seconds
                    setTimeout(checkAdminOrders, 2000);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Order failed: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
            }
        }

        // Check admin orders
        async function checkAdminOrders() {
            const resultDiv = document.getElementById('adminResult');
            resultDiv.innerHTML = '<div class="info">Checking admin orders...</div>';

            try {
                // Login as admin first
                if (!adminToken) {
                    const adminLogin = await fetch(`${API_BASE}/auth/admin-login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'bewithu.aj@gmail.com',
                            password: 'admin123'
                        })
                    });
                    const adminData = await adminLogin.json();
                    adminToken = adminData.token;
                }

                // Get recent orders
                const response = await fetch(`${API_BASE}/admin/orders?limit=5&sortBy=createdAt&sortOrder=desc`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();
                const orders = data.orders || [];

                if (orders.length > 0) {
                    let ordersList = '<div class="success">üìã Recent orders in admin panel:</div>';
                    orders.forEach((order, index) => {
                        const timeDiff = Math.round((Date.now() - new Date(order.createdAt).getTime()) / 60000);
                        ordersList += `
                            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <strong>#${order.orderNumber}</strong> - ${order.customerInfo.firstName} ${order.customerInfo.lastName}<br>
                                NPR ${order.pricing.total} - ${order.payment.method.toUpperCase()} - ${order.status}<br>
                                <small>${timeDiff} minutes ago</small>
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = ordersList;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå No orders found in admin panel</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Open admin panel
        function openAdminPanel() {
            window.open('http://localhost:3000/admin', '_blank');
        }

        // Auto-login on page load
        window.onload = function() {
            loginUser();
        };
    </script>
</body>
</html>
