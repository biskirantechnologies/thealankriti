<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Orders</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .order-row { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç Debug Admin Orders Panel</h1>

    <div class="test-section">
        <h2>1. Admin Authentication</h2>
        <button onclick="testAdminLogin()">Login as Admin</button>
        <div id="authResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Fetch Orders (Admin API)</h2>
        <button onclick="fetchOrders()">Get All Orders</button>
        <button onclick="fetchOrdersWithFilters()">Get Orders with Filters</button>
        <button onclick="fetchRecentOrders()">Get Recent Orders</button>
        <div id="ordersResult"></div>
        <div id="ordersDisplay"></div>
    </div>

    <div class="test-section">
        <h2>3. Create New Order</h2>
        <button onclick="createTestOrder()">Create Test Order</button>
        <div id="createOrderResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Live Refresh Test</h2>
        <button onclick="startAutoRefresh()">Start Auto Refresh (every 5s)</button>
        <button onclick="stopAutoRefresh()">Stop Auto Refresh</button>
        <div id="refreshResult"></div>
        <div id="liveOrderCount"></div>
    </div>

    <script>
        let adminToken = null;
        let userToken = null;
        let refreshInterval = null;
        const API_BASE = 'http://localhost:3001/api';

        // Test admin login
        async function testAdminLogin() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Testing admin login...</div>';

            try {
                const response = await fetch(`${API_BASE}/auth/admin-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'bewithu.aj@gmail.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    adminToken = data.token;
                    resultDiv.innerHTML = `<div class="success">‚úÖ Admin login successful! User: ${data.user.firstName} ${data.user.lastName}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Login error: ${error.message}</div>`;
            }
        }

        // Fetch orders
        async function fetchOrders() {
            if (!adminToken) {
                document.getElementById('ordersResult').innerHTML = '<div class="error">Please login first!</div>';
                return;
            }

            const resultDiv = document.getElementById('ordersResult');
            const displayDiv = document.getElementById('ordersDisplay');
            
            resultDiv.innerHTML = '<div class="info">Fetching orders...</div>';
            displayDiv.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/admin/orders`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const orders = data.orders || [];
                    resultDiv.innerHTML = `<div class="success">‚úÖ Fetched ${orders.length} orders successfully</div>`;
                    
                    if (orders.length > 0) {
                        displayDiv.innerHTML = '<h3>Orders:</h3>';
                        orders.forEach((order, index) => {
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'order-row';
                            orderDiv.innerHTML = `
                                <strong>Order #${index + 1}</strong><br>
                                Order Number: ${order.orderNumber}<br>
                                Customer: ${order.customerInfo.firstName} ${order.customerInfo.lastName}<br>
                                Email: ${order.customerInfo.email}<br>
                                Total: NPR ${order.pricing.total}<br>
                                Payment: ${order.payment.method.toUpperCase()}<br>
                                Status: ${order.status}<br>
                                Created: ${new Date(order.createdAt).toLocaleString()}<br>
                                Items: ${order.items.length} product(s)
                            `;
                            displayDiv.appendChild(orderDiv);
                        });
                    } else {
                        displayDiv.innerHTML = '<div class="info">No orders found</div>';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to fetch orders: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Fetch error: ${error.message}</div>`;
            }
        }

        // Fetch orders with filters
        async function fetchOrdersWithFilters() {
            if (!adminToken) {
                document.getElementById('ordersResult').innerHTML = '<div class="error">Please login first!</div>';
                return;
            }

            const resultDiv = document.getElementById('ordersResult');
            resultDiv.innerHTML = '<div class="info">Fetching orders with filters...</div>';

            try {
                // Test different filter combinations
                const filters = [
                    { name: 'All Orders', params: '' },
                    { name: 'Pending Orders', params: '?status=pending' },
                    { name: 'COD Orders', params: '?paymentMethod=cod' },
                    { name: 'Recent Orders', params: '?limit=5&sortBy=createdAt&sortOrder=desc' }
                ];

                let allResults = '';

                for (const filter of filters) {
                    const response = await fetch(`${API_BASE}/admin/orders${filter.params}`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });

                    const data = await response.json();
                    const count = data.orders?.length || 0;
                    allResults += `<div class="info">${filter.name}: ${count} orders</div>`;
                }

                resultDiv.innerHTML = allResults;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Filter test error: ${error.message}</div>`;
            }
        }

        // Fetch only recent orders
        async function fetchRecentOrders() {
            if (!adminToken) {
                document.getElementById('ordersResult').innerHTML = '<div class="error">Please login first!</div>';
                return;
            }

            const resultDiv = document.getElementById('ordersResult');
            const displayDiv = document.getElementById('ordersDisplay');
            
            try {
                const response = await fetch(`${API_BASE}/admin/orders?limit=10&sortBy=createdAt&sortOrder=desc`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                const orders = data.orders || [];

                resultDiv.innerHTML = `<div class="success">‚úÖ Recent orders: ${orders.length}</div>`;
                
                if (orders.length > 0) {
                    const latest = orders[0];
                    displayDiv.innerHTML = `
                        <h3>Latest Order:</h3>
                        <div class="order-row">
                            Order Number: ${latest.orderNumber}<br>
                            Customer: ${latest.customerInfo.firstName} ${latest.customerInfo.lastName}<br>
                            Total: NPR ${latest.pricing.total}<br>
                            Created: ${new Date(latest.createdAt).toLocaleString()}<br>
                            Minutes ago: ${Math.round((Date.now() - new Date(latest.createdAt).getTime()) / 60000)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Create test order
        async function createTestOrder() {
            if (!adminToken) {
                document.getElementById('createOrderResult').innerHTML = '<div class="error">Please login first!</div>';
                return;
            }

            const resultDiv = document.getElementById('createOrderResult');
            resultDiv.innerHTML = '<div class="info">Creating test order...</div>';

            try {
                // First create/login user
                let userResponse;
                try {
                    userResponse = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'test@example.com',
                            password: 'password123'
                        })
                    });
                } catch (e) {
                    // Create user
                    userResponse = await fetch(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            firstName: 'Test',
                            lastName: 'User',
                            email: 'test@example.com',
                            password: 'password123',
                            phone: '9876543210'
                        })
                    });
                }

                const userData = await userResponse.json();
                userToken = userData.token;

                // Create order
                const orderData = {
                    items: [{
                        product: "507f1f77bcf86cd799439011",
                        productSnapshot: {
                            name: `Test Product ${Date.now()}`,
                            sku: `TEST-${Date.now()}`,
                            image: "/uploads/products/test.jpg",
                            price: 1500,
                            specifications: {}
                        },
                        quantity: 1,
                        price: 1500,
                        variant: {}
                    }],
                    customerInfo: {
                        firstName: "Test",
                        lastName: "Customer",
                        email: "test@example.com",
                        phone: "9876543210"
                    },
                    shippingAddress: {
                        firstName: "Test",
                        lastName: "Customer",
                        email: "test@example.com",
                        phone: "9876543210",
                        street: "123 Main Street",
                        city: "Kathmandu",
                        state: "Bagmati",
                        zipCode: "44600"
                    },
                    payment: {
                        method: "cod",
                        status: "pending",
                        transactionId: `COD-${Date.now()}`
                    },
                    pricing: {
                        subtotal: 1500,
                        shippingCost: 100,
                        tax: 80,
                        discount: 0,
                        total: 1680
                    }
                };

                const orderResponse = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(orderData)
                });

                const orderResult = await orderResponse.json();

                if (orderResponse.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Test order created: ${orderResult.order.orderNumber}</div>`;
                    // Auto refresh orders after creation
                    setTimeout(fetchOrders, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Order creation failed: ${orderResult.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto refresh functions
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            document.getElementById('refreshResult').innerHTML = '<div class="info">Auto refresh started (every 5 seconds)</div>';
            
            refreshInterval = setInterval(async () => {
                if (!adminToken) return;
                
                try {
                    const response = await fetch(`${API_BASE}/admin/orders?limit=1`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });
                    const data = await response.json();
                    const count = data.pagination?.totalOrders || 0;
                    
                    document.getElementById('liveOrderCount').innerHTML = 
                        `<div class="info">üìä Total orders: ${count} (Last updated: ${new Date().toLocaleTimeString()})</div>`;
                } catch (error) {
                    document.getElementById('liveOrderCount').innerHTML = 
                        `<div class="error">‚ùå Refresh error: ${error.message}</div>`;
                }
            }, 5000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                document.getElementById('refreshResult').innerHTML = '<div class="info">Auto refresh stopped</div>';
            }
        }

        // Auto-start some tests
        window.onload = function() {
            testAdminLogin();
        };
    </script>
</body>
</html>
